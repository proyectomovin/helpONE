<div id="notification-rules-container" class="full-height uk-clearfix">
  <div class="uk-width-1-1 uk-margin-large-bottom">
    <h2 class="uk-float-left">Notification Rules</h2>
    <div class="uk-float-right">
      <a href="/settings/notification-rules/editor/new" class="uk-button uk-button-primary">
        <i class="fa fa-plus"></i> Create New Rule
      </a>
    </div>
  </div>

  <div class="uk-width-1-1">
    <div id="rules-loading" class="uk-text-center uk-margin-large-top">
      <i class="fa fa-spinner fa-spin fa-2x"></i>
      <p>Loading rules...</p>
    </div>

    <div id="rules-error" class="uk-alert uk-alert-danger" style="display: none;">
      <p id="error-message"></p>
    </div>

    <div id="rules-list" style="display: none;">
      <table class="uk-table uk-table-hover uk-table-striped">
        <thead>
          <tr>
            <th style="width: 50px;">
              <input type="checkbox" id="select-all-rules" />
            </th>
            <th>Name</th>
            <th>Event</th>
            <th>Priority</th>
            <th>Status</th>
            <th>Executions</th>
            <th>Last Executed</th>
            <th style="width: 150px;">Actions</th>
          </tr>
        </thead>
        <tbody id="rules-tbody">
          <!-- Rules will be populated here -->
        </tbody>
      </table>

      <div id="no-rules" class="uk-text-center uk-margin-large-top" style="display: none;">
        <i class="fa fa-inbox fa-4x uk-text-muted"></i>
        <p class="uk-text-large uk-text-muted">No notification rules found</p>
        <p class="uk-text-muted">Create your first automation rule to get started</p>
        <a href="/settings/notification-rules/editor/new" class="uk-button uk-button-primary uk-margin-top">
          <i class="fa fa-plus"></i> Create New Rule
        </a>
      </div>
    </div>
  </div>
</div>

{{#contentFor 'page-title'}}Notification Rules{{/contentFor}}

{{#contentFor 'page-script'}}
<script>
(function() {
  var rules = [];

  function loadRules() {
    $.ajax({
      url: '/api/v2/notification-rules',
      method: 'GET',
      success: function(response) {
        $('#rules-loading').hide();

        if (response.success && response.rules) {
          rules = response.rules;

          if (rules.length === 0) {
            $('#no-rules').show();
            $('#rules-list').hide();
          } else {
            renderRules();
            $('#rules-list').show();
            $('#no-rules').hide();
          }
        }
      },
      error: function(xhr) {
        $('#rules-loading').hide();
        $('#rules-error').show();
        $('#error-message').text('Error loading rules: ' + (xhr.responseJSON?.error?.message || 'Unknown error'));
      }
    });
  }

  function renderRules() {
    var tbody = $('#rules-tbody');
    tbody.empty();

    rules.forEach(function(rule) {
      var statusBadge = rule.isActive
        ? '<span class="uk-badge uk-badge-success">Active</span>'
        : '<span class="uk-badge">Inactive</span>';

      var lastExecuted = rule.lastExecutedAt
        ? new Date(rule.lastExecutedAt).toLocaleString()
        : 'Never';

      var row = $('<tr>').attr('data-rule-id', rule._id);

      row.append($('<td>').html('<input type="checkbox" class="rule-checkbox" data-id="' + rule._id + '" />'));
      row.append($('<td>').html('<a href="/settings/notification-rules/editor/' + rule._id + '">' + rule.name + '</a>'));
      row.append($('<td>').text(rule.eventType));
      row.append($('<td>').text(rule.priority));
      row.append($('<td>').html(statusBadge));
      row.append($('<td>').text(rule.stats?.totalExecutions || 0));
      row.append($('<td>').text(lastExecuted));

      var actions = $('<td>');
      actions.append($('<a>')
        .attr('href', '/settings/notification-rules/editor/' + rule._id)
        .addClass('uk-button uk-button-small uk-button-primary uk-margin-small-right')
        .html('<i class="fa fa-edit"></i>'));

      actions.append($('<button>')
        .addClass('uk-button uk-button-small uk-button-' + (rule.isActive ? 'warning' : 'success') + ' uk-margin-small-right')
        .attr('data-id', rule._id)
        .attr('data-active', rule.isActive)
        .html('<i class="fa fa-power-off"></i>')
        .on('click', toggleRule));

      actions.append($('<button>')
        .addClass('uk-button uk-button-small uk-button-danger')
        .attr('data-id', rule._id)
        .html('<i class="fa fa-trash"></i>')
        .on('click', deleteRule));

      row.append(actions);
      tbody.append(row);
    });
  }

  function toggleRule(e) {
    e.preventDefault();
    var btn = $(this);
    var ruleId = btn.data('id');

    $.ajax({
      url: '/api/v2/notification-rules/' + ruleId + '/toggle',
      method: 'POST',
      success: function(response) {
        if (response.success) {
          helpers.UI.showSnackbar('Rule ' + (response.rule.isActive ? 'activated' : 'deactivated') + ' successfully', false);
          loadRules();
        }
      },
      error: function(xhr) {
        helpers.UI.showSnackbar('Error toggling rule: ' + (xhr.responseJSON?.error?.message || 'Unknown error'), true);
      }
    });
  }

  function deleteRule(e) {
    e.preventDefault();
    var btn = $(this);
    var ruleId = btn.data('id');

    if (!confirm('Are you sure you want to delete this rule? This action cannot be undone.')) {
      return;
    }

    $.ajax({
      url: '/api/v2/notification-rules/' + ruleId,
      method: 'DELETE',
      success: function(response) {
        if (response.success) {
          helpers.UI.showSnackbar('Rule deleted successfully', false);
          loadRules();
        }
      },
      error: function(xhr) {
        helpers.UI.showSnackbar('Error deleting rule: ' + (xhr.responseJSON?.error?.message || 'Unknown error'), true);
      }
    });
  }

  // Initialize
  $(document).ready(function() {
    loadRules();

    // Select all checkbox
    $('#select-all-rules').on('change', function() {
      $('.rule-checkbox').prop('checked', $(this).is(':checked'));
    });
  });
})();
</script>
{{/contentFor}}
